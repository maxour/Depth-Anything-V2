<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>360 Debug Viewer</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"
    />
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"
    ></script>

    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        font-family: sans-serif;
        background-color: #000;
      }
      #app {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      /* å…¨æ™¯å®¹å™¨ */
      #panorama {
        width: 100%;
        height: 100%;
        z-index: 1;
      }
      /* æ§åˆ¶å±‚ */
      .controls {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 8px;
        color: white;
        backdrop-filter: blur(5px);
      }
      .file-input-wrapper {
        margin-bottom: 10px;
      }
      input[type="file"] {
        display: none;
      }
      .custom-file-upload {
        border: 1px solid #ccc;
        display: inline-block;
        padding: 6px 12px;
        cursor: pointer;
        background: #3498db;
        color: white;
        border-radius: 4px;
        transition: background 0.3s;
      }
      .custom-file-upload:hover {
        background: #2980b9;
      }
      .status {
        font-size: 12px;
        color: #aaa;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="panorama"></div>

      <div class="controls">
        <h3>360 Scene Debugger</h3>
        <p class="status">è¯·é€‰æ‹© Python ç”Ÿæˆçš„ scene_debug_v2.jpg</p>

        <div class="file-input-wrapper">
          <label for="file-upload" class="custom-file-upload">
            ğŸ“‚ æ‰“å¼€å›¾ç‰‡
          </label>
          <input
            id="file-upload"
            type="file"
            @change="handleFileUpload"
            accept="image/*"
          />
        </div>

        <div v-if="fileName" class="status">å½“å‰æ–‡ä»¶: {{ fileName }}</div>
        <div v-if="viewer" class="status">
          Pitch: {{ pitch.toFixed(1) }} | Yaw: {{ yaw.toFixed(1) }}
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, onMounted, onBeforeUnmount } = Vue;

      createApp({
        setup() {
          const viewer = ref(null);
          const fileName = ref("");
          const pitch = ref(0);
          const yaw = ref(0);
          let updateInterval = null;

          // åˆå§‹åŒ–æ’­æ”¾å™¨
          const initViewer = (imageSource) => {
            // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
            if (viewer.value) {
              viewer.value.destroy();
            }

            viewer.value = pannellum.viewer("panorama", {
              type: "equirectangular",
              panorama: imageSource,
              autoLoad: true,
              autoRotate: -2, // è´Ÿæ•°å‘å³è½¬ï¼Œæ­£æ•°å‘å·¦è½¬
              compass: true,
              showZoomCtrl: false, // æ»šè½®ç¼©æ”¾å³å¯
              pitch: -20, // åˆå§‹è§†è§’ç¨å¾®å‘ä¸‹çœ‹åœ°é¢ç½‘æ ¼
            });

            // å¯åŠ¨å®šæ—¶å™¨æ›´æ–° UI ä¸Šçš„åæ ‡æ˜¾ç¤º
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(() => {
              if (viewer.value) {
                pitch.value = viewer.value.getPitch();
                yaw.value = viewer.value.getYaw();
              }
            }, 100);
          };

          // å¤„ç†æ–‡ä»¶ä¸Šä¼  (è§£å†³æœ¬åœ°æ‰“å¼€ HTML çš„è·¨åŸŸé—®é¢˜)
          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            fileName.value = file.name;

            // ä½¿ç”¨ FileReader è¯»å–æœ¬åœ°æ–‡ä»¶ä¸º DataURL
            const reader = new FileReader();
            reader.onload = (e) => {
              const result = e.target.result;
              initViewer(result);
            };
            reader.readAsDataURL(file);
          };

          // å°è¯•åŠ è½½é»˜è®¤æ–‡ä»¶ (è¿™éœ€è¦ä½ åœ¨æœ¬åœ°å¯åŠ¨ http server æ‰èƒ½ç”Ÿæ•ˆ)
          onMounted(() => {
            // å¦‚æœä½ æƒ³åœ¨ server ç¯å¢ƒä¸‹ç›´æ¥åŠ è½½ï¼Œè§£å¼€ä¸‹é¢è¿™è¡Œ
            // initViewer('./scene_debug_v2.jpg');
          });

          onBeforeUnmount(() => {
            if (updateInterval) clearInterval(updateInterval);
          });

          return {
            handleFileUpload,
            fileName,
            viewer,
            pitch,
            yaw,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
